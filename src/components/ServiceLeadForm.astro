---
import CountrySelect from "./CountrySelect.astro";

const {
  servicio,
  ctaLabel = "Enviar y agendar",
  heading = "Antes de agendar",
  subheading = "Déjame tus datos y el objetivo de la sesión para prepararme mejor.",
  submitMode = "booking",
  stripeAsunto,
  stripePrecio,
  externalRedirectUrl,
} = Astro.props as {
  servicio: string;
  ctaLabel?: string;
  heading?: string;
  subheading?: string;
  submitMode?: "booking" | "stripe" | "external";
  stripeAsunto?: string;
  stripePrecio?: number;
  externalRedirectUrl?: string;
};

if (!servicio) {
  throw new Error("ServiceLeadForm requiere prop `servicio`");
}

const bookingHref = `/api/agendar?servicio=${encodeURIComponent(servicio)}`;
const actionJson = "/api/service-lead";
const actionRedirect = "/api/service-lead?redirect=1";
const stripeCheckoutAction = "/api/checkout";
const stripeCheckoutJson = "/api/checkout?json=1";
const formId = `service-lead-${servicio}`;
const statusId = `service-lead-status-${servicio}`;

if (submitMode === "stripe" && !stripeAsunto) {
  throw new Error("ServiceLeadForm en modo stripe requiere prop `stripeAsunto`");
}

if (submitMode === "external" && !externalRedirectUrl) {
  throw new Error("ServiceLeadForm en modo external requiere prop `externalRedirectUrl`");
}

const formAction = submitMode === "stripe" ? stripeCheckoutAction : actionRedirect;
---

<section class="mt-10 border border-gray-200 rounded-lg p-6 bg-white">
  <h2 class="text-xl font-semibold mb-2">{heading}</h2>
  <p class="text-sm text-gray-600 mb-6">{subheading}</p>

  <form id={formId} method="POST" action={formAction} class="space-y-4">
    <input type="hidden" name="servicio" value={servicio} />
    {submitMode === "stripe" && (
      <>
        <input type="hidden" name="asunto" value={stripeAsunto} />
        {typeof stripePrecio === "number" && (
          <input type="hidden" name="precio" value={stripePrecio.toString()} />
        )}
      </>
    )}

    <!-- honeypot anti-spam -->
    <div class="hidden" aria-hidden="true">
      <label for={`${formId}-website`}>Website</label>
      <input id={`${formId}-website`} type="text" name="website" tabindex="-1" autocomplete="off" />
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for={`${formId}-email`} class="block text-sm font-medium text-gray-800 mb-1">
          Email
        </label>
        <input
          id={`${formId}-email`}
          type="email"
          name="email"
          required
          autocomplete="email"
          class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
          placeholder="tu@email.com"
        />
      </div>

      <div>
        <label for={`${formId}-nombre`} class="block text-sm font-medium text-gray-800 mb-1">
          Nombre
        </label>
        <input
          id={`${formId}-nombre`}
          type="text"
          name="nombre"
          required
          autocomplete="name"
          class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
          placeholder="Tu nombre"
        />
      </div>
    </div>

    <CountrySelect />

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for={`${formId}-empresa`} class="block text-sm font-medium text-gray-800 mb-1">
          Empresa (Opcional)
        </label>
        <input
          id={`${formId}-empresa`}
          type="text"
          name="empresa"
          class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
          placeholder="Nombre de tu empresa"
        />
      </div>

      <div>
        <label for={`${formId}-url`} class="block text-sm font-medium text-gray-800 mb-1">
          URL (Opcional)
        </label>
        <input
          id={`${formId}-url`}
          type="url"
          name="url"
          class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
          placeholder="https://..."
        />
      </div>
    </div>

    <div>
      <label for={`${formId}-objetivo`} class="block text-sm font-medium text-gray-800 mb-1">
        ¿Cuál es tu objetivo principal?
      </label>
      <textarea
        id={`${formId}-objetivo`}
        name="objetivo"
        required
        rows={5}
        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
        placeholder="Ej: Quiero planificar la implementación, automatizar facturación, integrar con X, formar al equipo, etc."
      ></textarea>
    </div>

    <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
      <button
        type="submit"
        class="bg-black text-white font-semibold py-2 px-5 rounded hover:bg-gray-900 transition"
        data-submit
      >
        {ctaLabel}
      </button>
    </div>

    <div id={statusId} class="text-sm" aria-live="polite"></div>
  </form>
</section>

<script
  type="module"
  define:vars={{
    formId,
    statusId,
    bookingHref,
    actionJson,
    submitMode,
    stripeCheckoutJson,
    externalRedirectUrl,
  }}
>
  const form = document.getElementById(formId);
  const statusEl = document.getElementById(statusId);
  const submitBtn = form?.querySelector("[data-submit]");

  function setStatus(message, kind = "info") {
    if (!statusEl) return;
    const color =
      kind === "error" ? "text-red-600" : kind === "success" ? "text-green-700" : "text-gray-600";
    statusEl.className = `text-sm ${color}`;
    statusEl.textContent = message || "";
  }

  async function onSubmit(e) {
    e.preventDefault();
    if (!form) return;

    submitBtn?.setAttribute("disabled", "true");
    setStatus("Enviando...", "info");

    try {
      const res = await fetch(actionJson, { method: "POST", body: new FormData(form) });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data?.error || "No se pudo enviar el formulario.");
      }

      if (submitMode === "stripe") {
        setStatus("Listo. Redirigiendo a pago seguro…", "success");

        const checkoutRes = await fetch(stripeCheckoutJson, { method: "POST", body: new FormData(form) });
        const checkoutData = await checkoutRes.json().catch(() => ({}));
        if (!checkoutRes.ok || !checkoutData?.url) {
          throw new Error(checkoutData?.error || "No se pudo iniciar el pago.");
        }

        window.location.assign(checkoutData.url);
      } else if (submitMode === "external") {
        setStatus("Listo. Redirigiendo…", "success");
        window.location.assign(externalRedirectUrl);
      } else {
        setStatus("Listo. Redirigiendo a la agenda para que elijas un horario…", "success");
        // Usamos redirección en la misma pestaña para evitar bloqueadores de popups.
        window.location.assign(bookingHref);
      }
    } catch (err) {
      setStatus(err?.message || "Error enviando el formulario.", "error");
    } finally {
      submitBtn?.removeAttribute("disabled");
    }
  }

  form?.addEventListener("submit", onSubmit);
</script>
